# SM3 哈希算法与长度扩展攻击实现
## 简介
本项目提供了 SM3 密码杂凑算法的 C++ 实现，并包含对 SM3 长度扩展攻击 (Length Extension Attack) 的验证。SM3 是中国国家密码管理局发布的密码杂凑标准（GM/T 0004-2012），广泛应用于信息安全领域。

代码主要包含两部分功能：
完整实现 SM3 哈希算法，支持任意长度消息的哈希计算
实现并验证针对 SM3 的长度扩展攻击，展示哈希算法的这一安全特性

## 算法原理
SM3 哈希算法
SM3 算法采用 Merkle-Damgård 结构，主要流程包括：
消息预处理：对输入消息进行填充，使其长度为 512 位的整数倍
消息扩展：将 512 位消息块扩展为 68 个 32 位字和 64 个 32 位字
压缩函数：基于 8 个 32 位状态寄存器进行 64 轮迭代变换
结果输出：最终状态寄存器的值组合成 256 位哈希结果
核心变换包括：
布尔函数 FF 和 GG，随迭代轮数变化
置换函数 P0 和 P1，提供非线性变换
循环左移操作，增强算法的扩散性
长度扩展攻击
长度扩展攻击是针对使用 Merkle-Damgård 结构的哈希算法的一种攻击方式：
攻击者可利用已知的哈希值和原始消息长度，在未知原始消息的情况下，计算原始消息附加特定数据后的哈希值
攻击原理基于算法的迭代特性，利用已知哈希值作为新的初始状态，继续处理附加数据
本实现展示了如何构造这样的攻击，验证 SM3 算法对长度扩展攻击的脆弱性

## 核心代码解析
### SM3 类
实现 SM3 哈希算法的核心功能：
```
class SM3 {
public:
    // 常量定义（初始向量、块大小、摘要大小等）
    // 核心函数：
    static uint32_t RotL(uint32_t x, uint8_t n); // 循环左移
    static uint32_t FF(...) // 布尔函数FF
    static uint32_t GG(...) // 布尔函数GG
    static uint32_t P0(uint32_t x) // 置换函数P0
    static uint32_t P1(uint32_t x) // 置换函数P1
    static std::vector<uint8_t> PadMessage(...) // 消息填充
    static void Compress(...) // 压缩函数
    static std::vector<uint8_t> Hash(...) // 计算哈希主函数
};
```
### 消息填充：按照 SM3 标准对消息进行填充，确保长度满足算法要求
### 压缩函数：处理单个 512 位消息块，更新状态寄存器
### Hash 方法：算法入口，协调消息处理的全过程
### SM3LengthExtensionAttack 类
实现长度扩展攻击的功能：
```
class SM3LengthExtensionAttack {
public:
    static std::vector<uint8_t> ForgeHash(
        const uint32_t original_state[8],     // 原始消息的哈希状态
        size_t original_len,                   // 原始消息长度（字节）
        const std::vector<uint8_t>& append_data // 要追加的数据
    );
    // 辅助函数...
};
```
### ForgeHash 方法：核心攻击函数，利用原始哈希状态和长度，伪造附加数据后的哈希值
攻击过程包括计算填充长度、构造恶意消息、使用原始状态继续压缩过程
### 辅助功能
PrintHex：以十六进制格式打印数据，便于查看哈希结果
### main 函数：包含测试案例，验证 SM3 基础功能和长度扩展攻击效果

## 运行示例
程序执行结果如下：

测试消息的 SM3 哈希值
原始消息哈希、伪造哈希和实际哈希的对比
攻击是否成功的验证结果
测试验证
基础功能测试
验证 SM3 算法的基本哈希计算功能，对测试消息 "WZJ20040402" 计算哈希值。
长度扩展攻击测试

模拟攻击场景：

原始消息为 "secret_key" + "original_data"
攻击者已知原始消息哈希和长度，但不知道 "secret_key"
尝试追加 "malicious" 数据并伪造哈希值
对比伪造哈希与实际计算的哈希，验证攻击是否成功

## 结论
本实现完整展示了 SM3 哈希算法的工作原理和长度扩展攻击的实施方法。通过测试验证，证明了 SM3 算法与其他采用 Merkle-Damgård 结构的哈希算法一样，容易受到长度扩展攻击。

这一特性在实际应用中需要特别注意，尤其是在使用哈希进行消息认证时，应采取适当的防御措施（如使用 HMAC 等结构）。
## 参考标准
《GM/T 0004-2012 密码杂凑算法 SM3》
长度扩展攻击的理论基础与实践方法
